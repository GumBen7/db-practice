---
title: Лабораторная работа. Уровни изоляции транзакций в T-SQL
---

[К списку лабораторных >>>](../README.md)

---

### Задание

1. Установить в обоих сеансах уровень изоляции READ UNCOMMITTED. 
   * Выполнить сценарии проверки: потерянных изменений, грязного чтения.
2. Установить в обоих сеансах уровень изоляции READ COMMITTED. 
   * Выполнить сценарии проверки: грязного чтения. неповторяющегося чтения.
3. Установить в обоих сеансах уровень изоляции REPEATABLE READ. 
   * Выполнить сценарии проверки: неповторяющегося чтения, фантома.
4. Установить в обоих сеансах уровень изоляции SERIALIZABLE. 
   * Выполнить сценария проверки фантома. Записать протокол выполнения сценария.

---

### Аномалии доступа к базе данных

Стандарт SQL определяет уровни изоляции транзакций в многопользовательской системе 
через отсутствие таких аномалий доступа к базе данных, 
которые могут в конечном итоге угрожать целостности данных. 

В стандарте различаются следующие аномалии: 

#### Потерянные изменения (Lost Update)

– при одновременном изменении данных разными транзакциями одно из изменений будет потеряно

Транзакция Т1 читает данные. Транзакция Т2 читает те же данные.
Транзакция T1 на основании прочитанного значения вычисляет новое значение данных, записывает его в базу данных и завершается. 
Транзакция T2 на основании прочитанного значения вычисляет новое значение данных, записывает его в базу данных и завершается. 
В результате значение, записанное транзакцией Т2, "затрет" значение, записанное транзакцией Т1. 

#### Грязное чтение (Dirty Read)

– чтение неподтвержденных данных
 
Транзакция Т1 изменяет некоторые данные, но еще не завершается. 
Транзакция Т2 читает эти же данные (с изменениями, внесенными транзакцией Т1) 
и принимает на их основе какие-то решения. Транзакция Т1 выполняет откат. 
В результате решение, принятое транзакцией Т2 основано на неверных данных. 

#### Неповторяющееся чтение (Non-Repeatable Read)

– чтение измененных данных в рамках одной транзакции

Транзакция Т1 в ходе своего выполнения несколько раз читает одни и те же данные. 
Транзакция Т2 в интервалах между чтениями транзакцией Т1 изменяет эти данные и фиксируется.
В результате оказывается, что чтения одних и тех же данных в транзакции Т1 дает разные результаты. 

#### Фантом (Phantom Reads)

– чтение записей, которые появились между началом и завершением транзакции

Транзакция Т1 в ходе своего выполнения несколько раз выбирает множество строк по одним и тем же критериям.
Транзакция Т2 в интервалах между выборками транзакции Т1 добавляет или удаляет строки или изменяет столбцы некоторых строк, 
используемых в критерии выборки, и фиксируется. 
В результате оказывается, что одни и те же выборки в транзакции Т1 выбирают разные множество строк.

---

### Уровни изоляции транзакций в T-SQL

Во время выполнения транзакции все данные, над которыми производятся изменения, 
блокируются, до завершения транзакции, так как, когда один процесс изменяет данные, 
другой процесс не может одновременно изменять их. 

В SQL сервере существует механизм, который блокирует (изолирует) данные во время выполнения транзакции. 
У данного механизма есть несколько уровней изоляции, каждый из которых определяет степень блокировки данных.

Давайте подробней рассмотрим уровни изоляции.

#### READ UNCOMMITTED

Самый низкий уровень, при котором SQL сервер разрешает так называемое «грязное чтение». 
Грязным чтением называют считывание неподтвержденных данных, иными словами, 
если транзакция, которая изменяет данные, не завершена, другая транзакция может получить
уже измененные данные, хотя они еще не зафиксированы и могут отмениться.

#### READ COMMITTED

Этот уровень уже запрещает грязное чтение, в данном случае все процессы, запросившие данные, 
которые изменяются в тот же момент в другой транзакции, будут ждать завершения этой транзакции
и подтверждения фиксации данных. Данный уровень по умолчанию используется SQL сервером.

#### REPEATABLE READ

На данном уровне изоляции запрещается изменение данных между двумя операциями чтения в одной транзакции. 
Здесь происходит запрет на так называемое «неповторяющееся чтение» или «несогласованный анализ». 
Другими словами, если в одной транзакции есть несколько операций чтения, данные будут блокированы и 
их нельзя будет изменить в другой транзакции. Таким образом, вы избежите ситуации, когда вначале транзакции 
вы запросили данные, провели их анализ (некое вычисление), в конце транзакции запросили те же самые данные,
а они уже отличаются от первоначальных, так как они были изменены другой транзакцией.

Также уровень REPEATABLE READ, как и остальные, запрещает «Потерянное обновление» – 
это когда две транзакции сначала считывают одни и те же данные, а затем изменяют их на основе неких вычислений,
в результате обе транзакции выполнятся, но данные будут те, которая зафиксировала последняя операция обновления.
Это происходит потому, что данные в операциях чтения в начале этих транзакций не были заблокированы.

#### SERIALIZABLE

Данный уровень исключает чтение «фантомных» записей. Фантомные записи – это те записи, 
которые появились между началом и завершением транзакции. Иными словами, в начале транзакции 
вы запросили определенные данные, в конце транзакции вы запрашиваете их снова с тем же фильтром, 
но там уже есть и новые данные, которые добавлены другой транзакцией. 

Более низкие уровни изоляции не блокировали строки, которых еще нет в таблице,
данный уровень блокирует все строки, соответствующие фильтру запроса, 
с которыми будет работать транзакция, как существующие, так и те, что могут быть добавлены.

#### SNAPSHOT и READ COMMITTED SNAPSHOT

Также существуют уровни изоляции, алгоритм которых основан на версиях строк, это

* SNAPSHOT

* READ COMMITTED SNAPSHOT

Иными словами, SQL Server делает снимок и хранит последние версии подтвержденных строк. 
В данном случае, клиенту не нужно ждать снятия блокировок, пока одна транзакция изменит данные, 
он сразу получает последнюю версию подтвержденных строк.

Следует отметить, что уровни изоляции, основанные на версиях строк, 
замедляют операции обновления и удаления, так как перед этими операциями сервер делает 
и копирует снимок строк во временную базу данных.

SNAPSHOT – уровень хранит строки, подтверждённые на момент начала транзакции, соответственно, 
именно эти строки будут считаны в случае обращения к ним из другой транзакции. 
Данный уровень исключает повторяющееся и фантомное чтение примерно так же, как уровень SERIALIZABLE.

READ COMMITTED SNAPSHOT – этот уровень изоляции работает практически так же, как уровень SNAPSHOT, 
с одним отличием, он хранит снимок строк, которые подтверждены на момент запуска команды,
а не транзакции, как в SNAPSHOT.

---

### Включение уровня изоляции в T-SQL

Для того чтобы включить тот или иной уровень изоляции для всей сессии, 
необходимо выполнить команду SET TRANSACTION ISOLATION LEVEL и указать название уровня изоляции.
```sql   
   SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

Также для уровней SNAPSHOT и READ COMMITTED SNAPSHOT предварительно необходимо включить 
параметр базы данных ALLOW_SNAPSHOT_ISOLATION для уровня изоляции SNAPSHOT 
и READ_COMMITTED_SNAPSHOT для уровня READ COMMITTED SNAPSHOT.

Например
```sql
   ALTER DATABASE TestDB SET ALLOW_SNAPSHOT_ISOLATION ON;
```
